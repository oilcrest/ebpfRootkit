# eBPFRootkit

<p align="center">
  <strong>åŸºäº eBPF æŠ€æœ¯çš„å†…æ ¸çº§ Rootkit ç ”ç©¶é¡¹ç›®</strong>
</p>

<p align="center">
  <img src="https://img.shields.io/badge/Linux-Kernel-blue" alt="Linux Kernel">
  <img src="https://img.shields.io/badge/eBPF-CO--RE-green" alt="eBPF CO-RE">
  <img src="https://img.shields.io/badge/License-GPL%20v2-orange" alt="License">
  <img src="https://img.shields.io/badge/Purpose-Research%20Only-red" alt="Research Only">
</p>

---

## ğŸ“– é¡¹ç›®ç®€ä»‹

**eBPFRootkit** æ˜¯ä¸€ä¸ªå®éªŒæ€§çš„å®‰å…¨ç ”ç©¶é¡¹ç›®ï¼Œæ¢ç´¢ eBPFï¼ˆextended Berkeley Packet Filterï¼‰æŠ€æœ¯åœ¨ Linux å†…æ ¸å±‚é¢çš„é«˜çº§åº”ç”¨ã€‚æœ¬é¡¹ç›®æ·±å—ä»¥ä¸‹ä¼˜ç§€å¼€æºé¡¹ç›®çš„å¯å‘ï¼š

- **[ebpfkit](https://github.com/Gui774ume/ebpfkit)** - åŠŸèƒ½å®Œæ•´çš„ eBPF rootkitï¼Œå±•ç¤ºäº†ç½‘ç»œç›‘æ§ã€å®¹å™¨é€ƒé€¸å’ŒæŒä¹…åŒ–æŠ€æœ¯
- **[TripleCross](https://github.com/h3xduck/TripleCross)** - å¼ºå¤§çš„ Linux eBPF rootkitï¼Œå®ç°äº†åé—¨ã€C2ã€åº“æ³¨å…¥å’Œæ‰§è¡ŒåŠ«æŒ
- **[bad-bpf](https://github.com/pathtofile/bad-bpf)** - eBPF æ¶æ„è¡Œä¸ºç¤ºä¾‹é›†åˆï¼Œæ¼”ç¤ºå†…æ ¸ä¸ç”¨æˆ·æ€äº¤äº’

æœ¬é¡¹ç›®æ—¨åœ¨é€šè¿‡å®è·µè¿™äº›æŠ€æœ¯ï¼Œå¸®åŠ©å®‰å…¨ç ”ç©¶äººå‘˜å’Œé˜²å¾¡å·¥ç¨‹å¸ˆæ›´å¥½åœ°ç†è§£ eBPF æŠ€æœ¯çš„åŒåˆƒå‰‘ç‰¹æ€§ï¼Œå¹¶ä¸ºæ„å»ºé’ˆå¯¹æ€§çš„æ£€æµ‹å’Œé˜²å¾¡æœºåˆ¶æä¾›å‚è€ƒã€‚

---

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### å·²å®ç°åŠŸèƒ½

- **âœ… è¿›ç¨‹éšè—** - é€šè¿‡ Hook `getdents64` ç³»ç»Ÿè°ƒç”¨éšè—æŒ‡å®šè¿›ç¨‹
- **âœ… æ–‡ä»¶éšè—** - ä»ç›®å½•åˆ—è¡¨ä¸­éšè—ç‰¹å®šæ–‡ä»¶
- **âœ… eBPF å°¾è°ƒç”¨** - çªç ´ eBPF å¾ªç¯é™åˆ¶ï¼Œå¤„ç†å¤§å‹ç›®å½•
- **âœ… å†…æ ¸çº§åˆ«æ“ä½œ** - æ— éœ€ä¿®æ”¹æ–‡ä»¶ç³»ç»Ÿï¼Œç›´æ¥åœ¨å†…æ ¸å±‚é¢å®æ–½éšè—
- **âœ… CO-RE æ”¯æŒ** - ä¸€æ¬¡ç¼–è¯‘ï¼Œè·¨å†…æ ¸ç‰ˆæœ¬è¿è¡Œ

### è§„åˆ’ä¸­åŠŸèƒ½

- **ğŸ”„ ç½‘ç»œæµé‡æ“æ§** - é€æ˜ä»£ç†å’Œæµé‡é‡å®šå‘
- **ğŸ”„ ç³»ç»Ÿè°ƒç”¨æ‹¦æˆª** - åŠ¨æ€ä¿®æ”¹å…³é”®ç³»ç»Ÿè°ƒç”¨è¡Œä¸º
- **ğŸ”„ å‘½ä»¤ä¸æ§åˆ¶ï¼ˆC2ï¼‰** - å®ç°éšè”½çš„è¿œç¨‹æ§åˆ¶é€šé“
- **ğŸ”„ å†…å­˜æ³¨å…¥** - å‘ç›®æ ‡è¿›ç¨‹æ³¨å…¥ä»£ç 
- **ğŸ”„ æŒä¹…åŒ–æœºåˆ¶** - ç³»ç»Ÿé‡å¯åè‡ªåŠ¨åŠ è½½
- **ğŸ”„ åå–è¯æŠ€æœ¯** - é€ƒé¿å¸¸è§çš„å®‰å…¨æ£€æµ‹å·¥å…·

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ç”¨æˆ·æ€ (User Space)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  rootkit.c (æ§åˆ¶ç¨‹åº)               â”‚
â”‚  - åŠ è½½ eBPF ç¨‹åº                   â”‚
â”‚  - è®¾ç½®è¿‡æ»¤è§„åˆ™                     â”‚
â”‚  - è¯»å–å†…æ ¸æ•°æ®                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ libbpf
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     å†…æ ¸æ€ (Kernel Space)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  rootkit.bpf.c (eBPF ç¨‹åº)          â”‚
â”‚  - Tracepoint Hooks                 â”‚
â”‚  - Kprobe/Kretprobe Hooks           â”‚
â”‚  - eBPF Maps (æ•°æ®å­˜å‚¨)             â”‚
â”‚  - å°¾è°ƒç”¨ (Tail Calls)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®æŠ€æœ¯ç»„ä»¶

- **eBPF ç¨‹åº** (`rootkit.bpf.c`) - è¿è¡Œåœ¨å†…æ ¸æ€çš„æ ¸å¿ƒé€»è¾‘
- **ç”¨æˆ·æ€æ§åˆ¶ç¨‹åº** (`rootkit.c`) - ç®¡ç†å’Œé…ç½® eBPF ç¨‹åº
- **eBPF Maps** - å†…æ ¸ä¸ç”¨æˆ·æ€çš„æ•°æ®äº¤æ¢é€šé“
- **vmlinux.h** - BTF ç±»å‹ä¿¡æ¯ï¼Œå®ç° CO-RE
- **libbpf** - eBPF ç¨‹åºåŠ è½½å’Œç®¡ç†åº“

---

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

| ç»„ä»¶ | æŠ€æœ¯ | è¯´æ˜ |
|------|------|------|
| å†…æ ¸ç¨‹åº | C + eBPF | ä½¿ç”¨ eBPF å­—èŠ‚ç åœ¨å†…æ ¸æ€è¿è¡Œ |
| ç¼–è¯‘å·¥å…·é“¾ | LLVM/Clang | ç”Ÿæˆ eBPF å­—èŠ‚ç  |
| ç±»å‹ä¿¡æ¯ | BTF (BPF Type Format) | å®ç° CO-RE è·¨å†…æ ¸å…¼å®¹ |
| ç”¨æˆ·æ€åº“ | libbpf | eBPF ç¨‹åºçš„åŠ è½½å’Œç®¡ç† |
| æ„å»ºå·¥å…· | Makefile | è‡ªåŠ¨åŒ–ç¼–è¯‘æµç¨‹ |

---

## ğŸ“¦ ç¼–è¯‘ä¸å®‰è£…

### ç³»ç»Ÿè¦æ±‚

- Linux å†…æ ¸ç‰ˆæœ¬ >= 5.8ï¼ˆæ”¯æŒ BTF å’Œ CO-REï¼‰
- LLVM/Clang >= 10
- libbpf å¼€å‘åº“
- bpftool

### Ubuntu/Debian å®‰è£…ä¾èµ–

```bash
sudo apt update
sudo apt install -y clang llvm libelf-dev linux-headers-$(uname -r) \
                     build-essential libbpf-dev linux-tools-generic
```

### Fedora/RHEL å®‰è£…ä¾èµ–

```bash
sudo dnf install -y clang llvm elfutils-libelf-devel kernel-devel \
                     libbpf-devel bpftool
```

### ç¼–è¯‘é¡¹ç›®

```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/your-username/ebpfRootkit.git
git submodule update --init --recursive

cd ebpfRootkit

# ç¼–è¯‘
make

# ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶
./rootkit
```

---

## ğŸš€ ä½¿ç”¨è¯´æ˜

### åŸºæœ¬ç”¨æ³•

```bash
# ä»¥ root æƒé™è¿è¡Œï¼ˆeBPF éœ€è¦ CAP_BPF æˆ– root æƒé™ï¼‰
sudo ./rootkit
```

### è¿›ç¨‹éšè—ç¤ºä¾‹

```c
// åœ¨ rootkit.bpf.c ä¸­é…ç½®è¦éšè—çš„è¿›ç¨‹ ID
const volatile char pid_to_hide[MAX_PID_LEN] = "1234";
```

### æŸ¥çœ‹ eBPF ç¨‹åºçŠ¶æ€

```bash
# åˆ—å‡ºå·²åŠ è½½çš„ eBPF ç¨‹åº
sudo bpftool prog list

# æŸ¥çœ‹ eBPF Map å†…å®¹
sudo bpftool map dump name map_buffs
```

### å¸è½½ eBPF ç¨‹åº

```bash
# eBPF ç¨‹åºåœ¨ç”¨æˆ·æ€ç¨‹åºé€€å‡ºåè‡ªåŠ¨å¸è½½
# æˆ–æ‰‹åŠ¨é€šè¿‡ PID å¸è½½
sudo bpftool prog detach id <prog_id>
```

---

## ğŸ”¬ åŠŸèƒ½æ¼”ç¤º

### 1. è¿›ç¨‹éšè—

**ç›®æ ‡**ï¼šéšè—æŒ‡å®š PID çš„è¿›ç¨‹ï¼Œä½¿å…¶åœ¨ `ps`ã€`top` ç­‰å·¥å…·ä¸­ä¸å¯è§ã€‚

**å®ç°åŸç†**ï¼š
- Hook `sys_getdents64` ç³»ç»Ÿè°ƒç”¨
- è¿‡æ»¤æ‰ç›®æ ‡ PID å¯¹åº”çš„ç›®å½•é¡¹
- è°ƒæ•´è¿”å›çš„ç›®å½•æ¡ç›®å¤§å°

**æµ‹è¯•æ­¥éª¤**ï¼š

```bash
# 1. å¯åŠ¨ä¸€ä¸ªæµ‹è¯•è¿›ç¨‹
sleep 3600 &
echo $!  # è®°å½• PIDï¼Œå‡è®¾ä¸º 12345

# 2. é…ç½®å¹¶è¿è¡Œ rootkitï¼ˆä¿®æ”¹ä»£ç ä¸­çš„ pid_to_hideï¼‰
sudo ./rootkit

# 3. éªŒè¯éšè—æ•ˆæœ
ps aux | grep 12345  # ä¸ä¼šæ˜¾ç¤ºè¯¥è¿›ç¨‹
ls -la /proc/ | grep 12345  # /proc ç›®å½•ä¸­ä¸å¯è§
```

### 2. æ–‡ä»¶éšè—

**åŸç†**ï¼šä¸è¿›ç¨‹éšè—ç±»ä¼¼ï¼Œé€šè¿‡è¿‡æ»¤ `getdents64` è¿”å›ç»“æœå®ç°ã€‚

---

## ğŸ“ å­¦ä¹ èµ„æº

### eBPF åŸºç¡€

- [eBPF å®˜æ–¹æ–‡æ¡£](https://ebpf.io/)
- [libbpf](https://github.com/libbpf/) - eBPF libbpf å…¥é—¨
- [BPF CO-RE å‚è€ƒæŒ‡å—](https://nakryiko.com/posts/bpf-portability-and-co-re/)

### å†…æ ¸å®‰å…¨

- [Linux Kernel Module Programming Guide](https://sysprog21.github.io/lkmpg/)

---

## âš ï¸ å®‰å…¨è­¦å‘Šä¸å…è´£å£°æ˜

### ğŸ”´ é‡è¦å£°æ˜

1. **æœ¬é¡¹ç›®ä»…ç”¨äºåˆæ³•çš„å®‰å…¨ç ”ç©¶å’Œæ•™è‚²ç›®çš„**
2. **æœªç»æˆæƒåœ¨ç”Ÿäº§ç¯å¢ƒæˆ–ä»–äººç³»ç»Ÿä¸Šä½¿ç”¨æœ¬å·¥å…·æ˜¯è¿æ³•è¡Œä¸º**
3. **ä½œè€…ä¸å¯¹ä»»ä½•æ»¥ç”¨è¡Œä¸ºæ‰¿æ‹…è´£ä»»**
4. **ä½¿ç”¨è€…éœ€è‡ªè¡Œæ‰¿æ‹…æ‰€æœ‰æ³•å¾‹é£é™©**

### åˆæ³•ä½¿ç”¨åœºæ™¯

- âœ… åœ¨è‡ªå·±çš„ç³»ç»Ÿä¸Šè¿›è¡Œå®‰å…¨ç ”ç©¶
- âœ… è·å¾—æ˜ç¡®æˆæƒçš„æ¸—é€æµ‹è¯•
- âœ… å­¦æœ¯ç ”ç©¶å’Œæ•™å­¦
- âœ… å®‰å…¨äº§å“çš„æ£€æµ‹èƒ½åŠ›æµ‹è¯•

### ç¦æ­¢ä½¿ç”¨åœºæ™¯

- âŒ æœªç»æˆæƒè®¿é—®ä»–äººç³»ç»Ÿ
- âŒ çªƒå–æœºå¯†ä¿¡æ¯
- âŒ ç ´åç³»ç»ŸåŠŸèƒ½
- âŒ ä»»ä½•å½¢å¼çš„éæ³•æ´»åŠ¨

---

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼è´¡çŒ®å‰è¯·é˜…è¯»ä»¥ä¸‹è§„èŒƒï¼š

1. ä»£ç é£æ ¼éµå¾ª Linux å†…æ ¸ç¼–ç è§„èŒƒ
2. æäº¤å‰è¯·ç¡®ä¿ä»£ç å¯ä»¥ç¼–è¯‘é€šè¿‡
3. æ·»åŠ å¿…è¦çš„æ³¨é‡Šå’Œæ–‡æ¡£
4. æ–°åŠŸèƒ½éœ€è¦åŒ…å«ä½¿ç”¨è¯´æ˜

---

## ğŸ“š å‚è€ƒé¡¹ç›®

æœ¬é¡¹ç›®çš„å®ç°å‚è€ƒå’Œå­¦ä¹ äº†ä»¥ä¸‹ä¼˜ç§€å¼€æºé¡¹ç›®ï¼š

| é¡¹ç›® | ä½œè€… | ç‰¹ç‚¹ | é“¾æ¥ |
|------|------|------|------|
| **ebpfkit** | Gui774ume | å®Œæ•´çš„ eBPF rootkit æ¡†æ¶ï¼ŒC2 åŠŸèƒ½ | [GitHub](https://github.com/Gui774ume/ebpfkit) |
| **TripleCross** | h3xduck | åé—¨ã€åº“æ³¨å…¥ã€æ‰§è¡ŒåŠ«æŒ | [GitHub](https://github.com/h3xduck/TripleCross) |
| **bad-bpf** | pathtofile | eBPF æ¶æ„è¡Œä¸ºç¤ºä¾‹é›†åˆ | [GitHub](https://github.com/pathtofile/bad-bpf) |

---

## ğŸ“„ è®¸å¯è¯

- **eBPF å†…æ ¸ç¨‹åº** (`rootkit.bpf.c`) é‡‡ç”¨ **GPL v2** è®¸å¯è¯
- **ç”¨æˆ·æ€ä»£ç ** (`rootkit.c`) é‡‡ç”¨ **GPL v2** è®¸å¯è¯

eBPF ç¨‹åºå¿…é¡»ä½¿ç”¨ GPL å…¼å®¹è®¸å¯è¯æ‰èƒ½åŠ è½½åˆ° Linux å†…æ ¸ã€‚

---

## ğŸ“® è”ç³»æ–¹å¼

- **Issues**: é€šè¿‡ GitHub Issues æŠ¥å‘Šé—®é¢˜
- **è®¨è®º**: é€šè¿‡ GitHub Discussions å‚ä¸è®¨è®º

---

<p align="center">
  <strong>âš¡ ä»…ä¾›å®‰å…¨ç ”ç©¶å’Œæ•™è‚²ä½¿ç”¨ âš¡</strong><br>
  <em>è¯·è´Ÿè´£ä»»åœ°ä½¿ç”¨æŠ€æœ¯ï¼Œå…±åŒç»´æŠ¤ç½‘ç»œå®‰å…¨</em>
</p>
